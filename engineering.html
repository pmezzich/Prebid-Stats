<!DOCTYPE html>
<html>
<head>
  <title>Prebid Engineering</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #0b2c42;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    canvas {
      margin: 20px auto;
      display: block;
      max-width: 90%;
    }
    select {
      margin: 10px;
    }
  </style>
</head>
<body>
  <h2>Example Visualizations<br><em>Prebid Engineering</em></h2>
  <div>
    Filter by:
    <select id="dateFilter">
      <option>All Time</option>
    </select>
    <select id="companyFilter">
      <option>All Companies</option>
    </select>
    <select id="nameFilter">
      <option>All Names</option>
    </select>
  </div>
  <canvas id="chart1"></canvas>
  <canvas id="chart2"></canvas>
  <canvas id="chart3"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqslGsduWEZsf3Z-hKRsBygZ8B9Y9MiVk",
      authDomain: "prebid-email-bot.firebaseapp.com",
      databaseURL: "https://prebid-email-bot-default-rtdb.firebaseio.com",
      projectId: "prebid-email-bot",
      storageBucket: "prebid-email-bot.appspot.com",
      messagingSenderId: "950794998006",
      appId: "1:950794998006:web:07f7a6a91a3a39e7869f42"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const engRef = ref(db, "engineering");

    onValue(engRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      const entries = [];
      for (const company in data) {
        for (const user in data[company]) {
          const stats = data[company][user];
          entries.push({
            name: user,
            company: company,
            prs: stats.prs || 0,
            issues: stats.issues || 0,
            comments: stats.comments || 0,
          });
        }
      }

      // Sort and render
      entries.sort((a, b) => b.prs - a.prs);
      const labels = entries.map(e => `${e.name} (${e.company})`);
      const prData = entries.map(e => e.prs);
      const issueData = entries.map(e => e.issues);
      const commentData = entries.map(e => e.comments);

      const makeChart = (id, label, data) => {
        new Chart(document.getElementById(id), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label,
              data,
              backgroundColor: "#ff7f0e"
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: label,
                color: 'white'
              }
            },
            scales: {
              x: { ticks: { color: "white" }, grid: { color: "#345" } },
              y: { ticks: { color: "white" }, grid: { color: "#345" } }
            }
          }
        });
      };

      makeChart("chart1", "Top Contributors (PRs)", prData);
      makeChart("chart2", "Top Closers (Issues)", issueData);
      makeChart("chart3", "Top by Comments", commentData);
    });
  </script>
</body>
</html>
