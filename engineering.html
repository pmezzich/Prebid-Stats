
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>People View</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      background-color: #0a2c42;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    h1, h2 {
      margin: 20px 0 10px;
    }
    canvas {
      margin: 30px auto;
      display: block;
      width: 90% !important;
      max-width: 1000px;
      height: 600px !important;
    }
    select, input[type="date"], button {
      margin: 10px;
      padding: 5px;
      font-size: 16px;
    }
    .legend {
      margin-top: 30px;
    }
    .legend span {
      display: inline-block;
      margin-right: 20px;
    }
    .legend .member {
      color: orange;
    }
    .legend .nonmember {
      color: deepskyblue;
    }
  </style>
</head>
<body>
  <h1>Example Visualizations</h1>
  <h2><i>Prebid Engineering</i> - People View</h2>
  <div>
    Filter by:
    <select id="filterType">
      <option value="prs">Pull Requests</option>
      <option value="commits">Commits</option>
      <option value="issues">Issues</option>
      <option value="events">Events</option>
      <option value="prs_merged"># of PRâ€™s Merged</option>
      <option value="code_volume">Code Volume</option>
    </select>
    From: <input type="date" id="startDate">
    To: <input type="date" id="endDate">
    <select id="companySelect">
      <option value="all">All Companies</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
  </div>
  <canvas id="contribChart"></canvas>
  <script>
    const defaultStart = new Date();
    defaultStart.setMonth(defaultStart.getMonth() - 1);
    document.getElementById("startDate").value = defaultStart.toISOString().slice(0, 10);
    document.getElementById("endDate").value = new Date().toISOString().slice(0, 10);

    // Automatically apply filters once data is loaded
    const waitForDataAndDraw = async () => {
      rawData = await fetchData();
      companyMap = await getCompanyMap();
      const companySelect = document.getElementById("companySelect");
      const companies = new Set();
      for (const month in rawData) {
        for (const company in rawData[month]) {
          companies.add(company);
        }
      }
      [...companies].sort().forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        companySelect.appendChild(opt);
      });
      applyFilters();
    };
    window.onload = waitForDataAndDraw;
  </script>

  <div class="legend">
    <span class="member">â–  Member Company</span>
    <span class="nonmember">â–  Non-Member Company</span>
  </div>

  <script>
    const firebaseConfig = {
      databaseURL: "https://prebid-graphs-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let rawData = {};
    let companyMap = {};
    let chart = null;

    function fetchData() {
      return db.ref("stats").once("value").then(snapshot => snapshot.val());
    }

    function getCompanyMap() {
      return fetch("user_company_map.json").then(res => res.json());
    }

    function applyFilters() {
      const filterType = document.getElementById("filterType").value;
      const start = new Date(document.getElementById("startDate").value);
      const end = new Date(document.getElementById("endDate").value);
      const companyFilter = document.getElementById("companySelect").value;

      const dataset = {};
      for (const month in rawData) {
        const monthDate = new Date(month + "-01");
        if (monthDate < start || monthDate > end) continue;

        for (const company in rawData[month]) {
          if (companyFilter !== "all" && company !== companyFilter) continue;

          const people = rawData[month][company]["people"] || {};
          const member = rawData[month][company]["member"] || false;

          for (const person in people) {
            const val = people[person][filterType] || 0;
            const label = `${person} (${company})`;
            if (!dataset[label]) {
              dataset[label] = { value: 0, member };
            }
            dataset[label].value += val;
          }
        }
      }

      const labels = Object.keys(dataset);
      const data = labels.map(l => dataset[l].value);
      const colors = labels.map(l => dataset[l].member ? "orange" : "deepskyblue");

      if (chart) chart.destroy();
      const ctx = document.getElementById("contribChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: filterType,
            data,
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.parsed.y} ${filterType}`
              }
            }
          }
        }
      });
    }

    window.onload = async () => {
      rawData = await fetchData();
      companyMap = await getCompanyMap();

      const companySelect = document.getElementById("companySelect");
      const companies = new Set();
      for (const month in rawData) {
        for (const company in rawData[month]) {
          companies.add(company);
        }
      }
      [...companies].sort().forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        companySelect.appendChild(opt);
      });

      console.log("ðŸ”¥ Firebase data loaded:", rawData);
    };
  </script>
</body>
</html>
