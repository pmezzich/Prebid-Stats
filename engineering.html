<!DOCTYPE html>
<html>
<head>
  <title>Prebid Engineering</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #0b2c42;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    canvas {
      margin: 20px auto;
      display: block;
      max-width: 90%;
    }
    select {
      margin: 10px;
    }
  </style>
</head>
<body>
  <h2>Example Visualizations<br><em>Prebid Engineering</em></h2>
  <div>
    Filter by:
    <select id="dateFilter">
      <option>All Time</option>
    </select>
    <select id="companyFilter">
      <option>All Companies</option>
    </select>
    <select id="nameFilter">
      <option>All Names</option>
    </select>
  </div>
  <canvas id="chart1"></canvas>
  <canvas id="chart2"></canvas>
  <canvas id="chart3"></canvas>

  <script>
    async function loadData() {
      const res = await fetch("https://prebid-graphs-default-rtdb.firebaseio.com/engineering.json");
      const data = await res.json();

      const userStats = {};

      Object.entries(data || {}).forEach(([company, users]) => {
        Object.entries(users || {}).forEach(([username, stats]) => {
          const key = username + " (" + company + ")";
          userStats[key] = {
            prs: stats.prs || 0,
            issues: stats.issues || 0,
            comments: stats.comments || 0,
            company: company,
            name: username
          };
        });
      });

      const names = Object.keys(userStats);
      const prs = names.map(name => userStats[name].prs);
      const issues = names.map(name => userStats[name].issues);
      const comments = names.map(name => userStats[name].comments);

      const colors = names.map(name => userStats[name].member ? "#ff7f0e" : "#1f77b4");

      const createChart = (ctxId, label, dataValues) => {
        new Chart(document.getElementById(ctxId), {
          type: 'bar',
          data: {
            labels: names,
            datasets: [{
              label,
              data: dataValues,
              backgroundColor: colors
            }]
          },
          options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            responsive: true
          }
        });
      };

      createChart("chart1", "Top Closers", issues);
      createChart("chart2", "Top Contributors", prs);
      createChart("chart3", "Top by Comments", comments);
    }

    loadData();
  </script>
</body>
</html>
