
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prebid Engineering - People View</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      background-color: #0a2c42;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    h1, h2 {
      margin: 20px 0 10px;
    }
    canvas {
      margin: 30px auto;
      display: block;
      width: 90% !important;
      max-width: 1000px;
      height: 600px !important;
    }
    select, button {
      margin: 0 10px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h1>Example Visualizations</h1>
  <h2><em>Prebid Engineering</em> - People View</h2>
  <div>
    Filter by:
    <select id="dateFilter">
      <option value="all">All Time</option>
      <option value="month">This Month</option>
      <option value="quarter">This Quarter</option>
      <option value="year">This Year</option>
    </select>
    <select id="companyFilter">
      <option value="all">All Companies</option>
    </select>
    <select id="personFilter">
      <option value="all">All Names</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
  </div>
  <canvas id="issuesChart"></canvas>
  <canvas id="prsChart"></canvas>
  <script>
    const firebaseConfig = {
      databaseURL: "https://prebid-graphs-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let fullData = {};

    function getCurrentPeriod(key, filter) {
      const [year, month] = key.split("-");
      const today = new Date();
      if (filter === "month") {
        return key === today.toISOString().slice(0, 7);
      } else if (filter === "quarter") {
        const quarter = Math.floor((today.getMonth()) / 3) + 1;
        const dataQuarter = Math.floor((parseInt(month) - 1) / 3) + 1;
        return parseInt(year) === today.getFullYear() && quarter === dataQuarter;
      } else if (filter === "year") {
        return parseInt(year) === today.getFullYear();
      }
      return true;
    }

    function loadData() {
      db.ref("stats").once("value", snapshot => {
        fullData = snapshot.val();
        populateFilters();
        applyFilters();
      });
    }

    function populateFilters() {
      const companySet = new Set();
      const personSet = new Set();
      for (const month in fullData) {
        for (const company in fullData[month]) {
          companySet.add(company);
          const entry = fullData[month][company];
          if (entry.people) {
            for (const person in entry.people) {
              personSet.add(person);
            }
          }
        }
      }

      const companyFilter = document.getElementById("companyFilter");
      const personFilter = document.getElementById("personFilter");

      companySet.forEach(c => {
        const opt = document.createElement("option");
        opt.value = opt.text = c;
        companyFilter.appendChild(opt);
      });

      personSet.forEach(p => {
        const opt = document.createElement("option");
        opt.value = opt.text = p;
        personFilter.appendChild(opt);
      });
    }

    function applyFilters() {
      const dateFilter = document.getElementById("dateFilter").value;
      const companyFilter = document.getElementById("companyFilter").value;
      const personFilter = document.getElementById("personFilter").value;

      const issuesMap = {};
      const prsMap = {};

      for (const month in fullData) {
        if (!getCurrentPeriod(month, dateFilter)) continue;

        for (const company in fullData[month]) {
          if (companyFilter !== "all" && company !== companyFilter) continue;
          const people = fullData[month][company].people || {};
          for (const person in people) {
            if (personFilter !== "all" && person !== personFilter) continue;
            const data = people[person];
            issuesMap[`${person} (${company})`] = (issuesMap[`${person} (${company})`] || 0) + (data.issues || 0);
            prsMap[`${person} (${company})`] = (prsMap[`${person} (${company})`] || 0) + (data.prs || 0);
          }
        }
      }

      renderChart("issuesChart", "Top Closers", issuesMap);
      renderChart("prsChart", "Top Contributors", prsMap);
    }

    function renderChart(canvasId, label, dataMap) {
      const canvas = document.getElementById(canvasId);
      const dpr = window.devicePixelRatio || 1;
      canvas.width = canvas.clientWidth * dpr;
      canvas.height = canvas.clientHeight * dpr;
      const ctx = canvas.getContext("2d");
      ctx.scale(dpr, dpr);

      const sorted = Object.entries(dataMap).sort((a, b) => b[1] - a[1]).slice(0, 30);
      const labels = sorted.map(i => i[0]);
      const values = sorted.map(i => i[1]);

      if (window[canvasId + "_instance"]) {
        window[canvasId + "_instance"].destroy();
      }

      window[canvasId + "_instance"] = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label,
            data: values,
            backgroundColor: "rgba(255, 255, 255, 0.7)"
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          scales: {
            x: {
              beginAtZero: true,
              ticks: { color: "white", font: { size: 14 } },
              grid: { color: "gray" }
            },
            y: {
              ticks: { color: "white", font: { size: 14 } },
              grid: { color: "gray" }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: "white",
                font: { size: 16, weight: "bold" }
              }
            }
          },
          elements: {
            bar: {
              borderWidth: 1
            }
          }
        }
      });
    }

    loadData();
  </script>
</body>
</html>
