
<!DOCTYPE html>
<html>
<head>
  <title>People View</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #042b44;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    canvas {
      width: 90% !important;
      height: 600px !important;
      margin: 40px auto;
    }
    select, button {
      margin: 10px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h2>Example Visualizations<br><em>Prebid Engineering</em> - People View</h2>
  <div>
    <label>Filter by:</label>
    <select id="timeFilter">
      <option value="all">All Time</option>
      <option value="month">This Month</option>
      <option value="quarter">This Quarter</option>
      <option value="year">This Year</option>
    </select>
    <select id="companyFilter">
      <option value="all">All Companies</option>
    </select>
    <select id="nameFilter">
      <option value="all">All Names</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
  </div>

  <canvas id="closersChart"></canvas>
  <canvas id="contributorsChart"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      get,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7lPuRWn8oflKZn4nmbdSREz35HaUbFnI",
      authDomain: "prebid-graphs-default.firebaseapp.com",
      databaseURL: "https://prebid-graphs-default-rtdb.firebaseio.com",
      projectId: "prebid-graphs-default",
      storageBucket: "prebid-graphs-default.appspot.com",
      messagingSenderId: "277285460770",
      appId: "1:277285460770:web:0d0a03716ab870c9b330b2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let fullData = [];

    function getCurrentPeriod(filter) {
      const now = new Date();
      if (filter === "month") return now.toISOString().slice(0, 7);
      if (filter === "year") return now.getFullYear().toString();
      if (filter === "quarter") {
        const q = Math.floor((now.getMonth() + 3) / 3);
        return `${now.getFullYear()}-Q${q}`;
      }
      return "all";
    }

    function applyFilters() {
      const timeFilter = document.getElementById("timeFilter").value;
      const companyFilter = document.getElementById("companyFilter").value;
      const nameFilter = document.getElementById("nameFilter").value;

      const filtered = fullData.filter(item => {
        if (companyFilter !== "all" && item.company !== companyFilter) return false;
        if (nameFilter !== "all" && item.name !== nameFilter) return false;
        return true;
      });

      const closers = {};
      const contributors = {};

      filtered.forEach(({ name, company, prs, issues, member }) => {
        const label = `${name} (${company})`;
        if (!closers[label]) closers[label] = { count: 0, member };
        if (!contributors[label]) contributors[label] = { count: 0, member };

        closers[label].count += issues;
        contributors[label].count += prs;
      });

      renderChart("closersChart", closers, "Top Closers");
      renderChart("contributorsChart", contributors, "Top Contributors");
    }

    function renderChart(canvasId, dataObj, title) {
      const ctx = document.getElementById(canvasId).getContext("2d");
      if (window[canvasId]) window[canvasId].destroy();

      const sorted = Object.entries(dataObj).sort((a, b) => b[1].count - a[1].count).slice(0, 25);
      const labels = sorted.map(([label]) => label);
      const data = sorted.map(([, val]) => val.count);
      const colors = sorted.map(([, val]) => val.member ? "orange" : "blue");

      window[canvasId] = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: title,
            data,
            backgroundColor: colors
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: title,
              color: 'white'
            }
          },
          scales: {
            x: { ticks: { color: "white" }, grid: { color: "gray" }},
            y: { ticks: { color: "white" }, grid: { color: "gray" }}
          }
        }
      });
    }

    const statsRef = ref(db, 'stats/2025-07');
    get(statsRef).then(snapshot => {
      const companies = snapshot.val();
      const companiesList = new Set();
      const namesList = new Set();
      fullData = [];

      for (const company in companies) {
        const people = companies[company]?.people || {};
        for (const name in people) {
          const entry = people[name];
          fullData.push({
            name,
            company,
            prs: entry.prs || 0,
            issues: entry.issues || 0,
            member: entry.member || false,
          });
          companiesList.add(company);
          namesList.add(name);
        }
      }

      const companySelect = document.getElementById("companyFilter");
      [...companiesList].sort().forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        companySelect.appendChild(opt);
      });

      const nameSelect = document.getElementById("nameFilter");
      [...namesList].sort().forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        nameSelect.appendChild(opt);
      });

      applyFilters();
    });
  </script>
</body>
</html>
