
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prebid Engineering - People View</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #042b44;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
        }
        h1 {
            margin-top: 20px;
        }
        canvas {
            max-width: 90vw;
            margin: 40px auto;
            display: block;
        }
        .filters {
            margin: 20px;
        }
        select, button {
            padding: 5px 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Example Visualizations<br><em>Prebid Engineering</em> - People View</h1>
    <div class="filters">
        <label>Filter by:</label>
        <select id="dateFilter">
            <option>All Time</option>
            <option>This Month</option>
            <option>This Quarter</option>
            <option>This Year</option>
        </select>
        <select id="companyFilter">
            <option>All Companies</option>
        </select>
        <select id="nameFilter">
            <option>All Names</option>
        </select>
        <button onclick="applyFilters()">Apply Filters</button>
    </div>
    <canvas id="closersChart"></canvas>
    <canvas id="contributorsChart"></canvas>

    <script>
        async function fetchData() {
            const response = await fetch("https://prebid-graphs-default-rtdb.firebaseio.com/stats.json");
            return await response.json();
        }

        function applyFilters() {
            loadData(); // simply reload for now
        }

        function getCurrentDatePrefix(filter) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');

            if (filter === "All Time") return "";
            if (filter === "This Month") return `${year}-${month}`;
            if (filter === "This Year") return `${year}-`;
            if (filter === "This Quarter") {
                const q = Math.floor((now.getMonth() + 3) / 3);
                const startMonth = String((q - 1) * 3 + 1).padStart(2, '0');
                return `${year}-${startMonth}`;
            }
            return "";
        }

        function getBarColor(isMember) {
            return isMember ? "orange" : "dodgerblue";
        }

        function renderChart(canvasId, title, labels, values, colors) {
            const ctx = document.getElementById(canvasId).getContext("2d");
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: values,
                        backgroundColor: colors
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: title,
                            color: "white",
                            font: { size: 16 }
                        }
                    }
                }
            });
        }

        async function loadData() {
            const raw = await fetchData();
            const prefix = getCurrentDatePrefix(document.getElementById("dateFilter").value);
            const peopleStats = {};

            for (const date in raw) {
                if (!date.startsWith(prefix)) continue;
                const companies = raw[date];
                for (const company in companies) {
                    const data = companies[company];
                    if (data.people) {
                        for (const person in data.people) {
                            if (!peopleStats[person]) peopleStats[person] = { prs: 0, issues: 0, company: company, member: data.people[person].member || false };
                            peopleStats[person].prs += data.people[person].prs || 0;
                            peopleStats[person].issues += data.people[person].issues || 0;
                        }
                    }
                }
            }

            const topContributors = Object.entries(peopleStats).sort((a, b) => b[1].prs - a[1].prs).slice(0, 30);
            const topClosers = Object.entries(peopleStats).sort((a, b) => b[1].issues - a[1].issues).slice(0, 30);

            const contribLabels = topContributors.map(e => `${e[0]} (${e[1].company})`);
            const contribData = topContributors.map(e => e[1].prs);
            const contribColors = topContributors.map(e => getBarColor(e[1].member));

            const closeLabels = topClosers.map(e => `${e[0]} (${e[1].company})`);
            const closeData = topClosers.map(e => e[1].issues);
            const closeColors = topClosers.map(e => getBarColor(e[1].member));

            document.getElementById("closersChart").height = 1200;
            document.getElementById("contributorsChart").height = 1200;

            renderChart("closersChart", "Top Closers", closeLabels, closeData, closeColors);
            renderChart("contributorsChart", "Top Contributors", contribLabels, contribData, contribColors);
        }

        loadData();
    </script>
</body>
</html>
