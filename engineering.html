
<!DOCTYPE html>
<html>
<head>
  <title>Prebid Engineering - People View</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #042b44;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    canvas {
      max-width: 90vw;
      height: 600px !important;
      margin: 40px auto;
    }
    select, button {
      margin: 10px;
      padding: 5px;
    }
    .chart-container {
      width: 90%;
      margin: auto;
    }
  </style>
</head>
<body>
  <h2>Example Visualizations<br><em>Prebid Engineering</em> - People View</h2>
  <div>
    <label>Filter by:</label>
    <select id="timeFilter">
      <option value="all">All Time</option>
      <option value="month">This Month</option>
      <option value="quarter">This Quarter</option>
      <option value="year">This Year</option>
    </select>
    <select id="companyFilter">
      <option value="all">All Companies</option>
    </select>
    <select id="nameFilter">
      <option value="all">All Names</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
  </div>

  <div class="chart-container">
    <canvas id="closersChart"></canvas>
    <canvas id="contributorsChart"></canvas>
  </div>

  <script>
    const firebaseUrl = "https://prebid-graphs-default-rtdb.firebaseio.com/stats.json";

    let rawData = {};
    let companies = new Set();
    let names = new Set();

    async function loadData() {
      const res = await fetch(firebaseUrl);
      const data = await res.json();
      rawData = data || {};
      populateFilters();
      renderCharts();
    }

    function populateFilters() {
      const companySelect = document.getElementById('companyFilter');
      const nameSelect = document.getElementById('nameFilter');
      companies.clear();
      names.clear();

      Object.values(rawData).forEach(snapshot => {
        Object.entries(snapshot).forEach(([company, info]) => {
          if (company !== "people") {
            companies.add(company);
          } else {
            Object.entries(info).forEach(([person, stats]) => {
              names.add(person);
              if (stats.company) companies.add(stats.company);
            });
          }
        });
      });

      companies.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        companySelect.appendChild(opt);
      });

      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        nameSelect.appendChild(opt);
      });
    }

    function applyFilters() {
      renderCharts();
    }

    function renderCharts() {
      const timeFilter = document.getElementById("timeFilter").value;
      const companyFilter = document.getElementById("companyFilter").value;
      const nameFilter = document.getElementById("nameFilter").value;

      const closers = {};
      const contributors = {};

      Object.entries(rawData).forEach(([month, snapshot]) => {
        Object.entries(snapshot.people || {}).forEach(([person, stats]) => {
          if ((companyFilter === "all" || stats.company === companyFilter) &&
              (nameFilter === "all" || person === nameFilter)) {
            if (!closers[person]) closers[person] = 0;
            if (!contributors[person]) contributors[person] = 0;
            closers[person] += stats.issues || 0;
            contributors[person] += stats.prs || 0;
          }
        });
      });

      drawChart("closersChart", "Top Closers", closers);
      drawChart("contributorsChart", "Top Contributors", contributors);
    }

    function drawChart(id, label, data) {
      const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, 20);
      const ctx = document.getElementById(id).getContext("2d");
      if (window[id]) window[id].destroy();

      const colors = sorted.map(([name]) => name.includes("Prebid") ? "orange" : "steelblue");

      window[id] = new Chart(ctx, {
        type: "bar",
        data: {
          labels: sorted.map(([name]) => name),
          datasets: [{
            label: label,
            data: sorted.map(([_, count]) => count),
            backgroundColor: colors
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { beginAtZero: true },
            y: {
              ticks: {
                color: 'white',
                font: {
                  size: 12
                }
              }
            }
          },
          plugins: {
            legend: { display: true, labels: { color: 'white' } },
            tooltip: { enabled: true }
          }
        }
      });
    }

    loadData();
  </script>
</body>
</html>
