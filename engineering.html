
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>People View</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      background-color: #0a2c42;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    canvas {
      max-width: 90vw;
      height: 600px !important;
      margin: 30px auto;
    }
    select, button {
      margin: 10px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h2>Example Visualizations<br><em>Prebid Engineering</em> - People View</h2>
  <div>
    <label>Filter by:</label>
    <select id="dateFilter">
      <option value="all">All Time</option>
    </select>
    <select id="companyFilter">
      <option value="all">All Companies</option>
    </select>
    <select id="nameFilter">
      <option value="all">All Names</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
  </div>

  <canvas id="closersChart"></canvas>
  <canvas id="contributorsChart"></canvas>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB7lPuRWn8oflKZn4nmbdSREz35HaUbFnI",
      authDomain: "prebid-graphs-default.firebaseapp.com",
      databaseURL: "https://prebid-graphs-default-rtdb.firebaseio.com",
      projectId: "prebid-graphs-default",
      storageBucket: "prebid-graphs-default.appspot.com",
      messagingSenderId: "277285460770",
      appId: "1:277285460770:web:0d0a03716ab870c9b330b2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let rawData = {};

    function getBarColor(member) {
      return member ? "orange" : "steelblue";
    }

    function applyFilters() {
      drawCharts();
    }

    function drawCharts() {
      const peopleStats = {};

      Object.entries(rawData).forEach(([month, snapshot]) => {
        Object.entries(snapshot).forEach(([company, data]) => {
          if (!data.people) return;
          Object.entries(data.people).forEach(([name, info]) => {
            if (!peopleStats[name]) {
              peopleStats[name] = { prs: 0, issues: 0, member: info.member, company };
            }
            peopleStats[name].prs += info.prs || 0;
            peopleStats[name].issues += info.issues || 0;
          });
        });
      });

      const sortedContributors = Object.entries(peopleStats)
        .sort((a, b) => b[1].prs - a[1].prs).slice(0, 30);
      const sortedClosers = Object.entries(peopleStats)
        .sort((a, b) => b[1].issues - a[1].issues).slice(0, 30);

      const contribLabels = sortedContributors.map(([name, val]) => `${name} (${val.company})`);
      const contribValues = sortedContributors.map(([_, val]) => val.prs);
      const contribColors = sortedContributors.map(([_, val]) => getBarColor(val.member));

      const closerLabels = sortedClosers.map(([name, val]) => `${name} (${val.company})`);
      const closerValues = sortedClosers.map(([_, val]) => val.issues);
      const closerColors = sortedClosers.map(([_, val]) => getBarColor(val.member));

      createChart("contributorsChart", "Top Contributors", contribLabels, contribValues, contribColors);
      createChart("closersChart", "Top Closers", closerLabels, closerValues, closerColors);
    }

    function createChart(id, label, labels, data, colors) {
      const ctx = document.getElementById(id).getContext("2d");
      if (window[id]) window[id].destroy();

      window[id] = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label,
            data,
            backgroundColor: colors
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { beginAtZero: true },
            y: {
              ticks: {
                color: 'white',
                font: { size: 12 }
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          }
        }
      });
    }

    firebase.database().ref("stats").once("value").then(snapshot => {
      rawData = snapshot.val();
      drawCharts();
    });
  </script>
</body>
</html>
