<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prebid Engineering - People Contributions</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #042C45;
      color: #ffffff;
      text-align: center;
    }
    h2 {
      margin-top: 20px;
    }
    canvas {
      margin: 40px auto;
      display: block;
      max-width: 1000px;
      max-height: 600px;
    }
    .filters {
      margin: 20px;
    }
    select {
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <h2>Example Visualizations<br><i>Prebid Engineering</i></h2>
  <div class="filters">
    <label>Filter by:</label>
    <select id="timeSelect">
      <option value="all">All Time</option>
      <option value="2025-07">July 2025</option>
    </select>
    <select id="companySelect">
      <option value="all">All Companies</option>
    </select>
    <select id="personSelect">
      <option value="all">All Names</option>
    </select>
  </div>
  <canvas id="issuesChart"></canvas>
  <canvas id="prsChart"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      get,
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    const firebaseConfig = {
      databaseURL: "https://prebid-graphs-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const timeSelect = document.getElementById("timeSelect");
    const companySelect = document.getElementById("companySelect");
    const personSelect = document.getElementById("personSelect");

    let issuesChart, prsChart;

    function drawChart(ctx, label, data, title) {
      return new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.map(d => d.label),
          datasets: [{
            label: label,
            data: data.map(d => d.value),
            backgroundColor: "#00c8ff",
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: title
            }
          },
          scales: {
            x: {
              ticks: { beginAtZero: true }
            }
          }
        }
      });
    }

    async function loadData() {
      const snapshot = await get(ref(db, "stats/2025-07"));
      const data = snapshot.val();
      if (!data) return;

      const people = [];

      Object.entries(data).forEach(([company, info]) => {
        if (info.people) {
          Object.entries(info.people).forEach(([person, stats]) => {
            people.push({
              person: person,
              company: company,
              issues: stats.issues || 0,
              prs: stats.prs || 0
            });
          });
        }
      });

      const selectedCompany = companySelect.value;
      const selectedPerson = personSelect.value;

      let filtered = people;
      if (selectedCompany !== "all") {
        filtered = filtered.filter(p => p.company === selectedCompany);
      }
      if (selectedPerson !== "all") {
        filtered = filtered.filter(p => p.person === selectedPerson);
      }

      const topIssues = [...filtered]
        .sort((a, b) => b.issues - a.issues)
        .slice(0, 15)
        .map(p => ({ label: p.person + " (" + p.company + ")", value: p.issues }));

      const topPRs = [...filtered]
        .sort((a, b) => b.prs - a.prs)
        .slice(0, 15)
        .map(p => ({ label: p.person + " (" + p.company + ")", value: p.prs }));

      if (issuesChart) issuesChart.destroy();
      if (prsChart) prsChart.destroy();

      issuesChart = drawChart(document.getElementById("issuesChart"), "Issues", topIssues, "Top Closers");
      prsChart = drawChart(document.getElementById("prsChart"), "PRs", topPRs, "Top Contributors");

      // Populate filters
      const companies = Array.from(new Set(people.map(p => p.company))).sort();
      companySelect.innerHTML = '<option value="all">All Companies</option>' + companies.map(c => `<option value="${c}">${c}</option>`).join("");

      const peopleNames = Array.from(new Set(people.map(p => p.person))).sort();
      personSelect.innerHTML = '<option value="all">All Names</option>' + peopleNames.map(n => `<option value="${n}">${n}</option>`).join("");
    }

    timeSelect.addEventListener("change", loadData);
    companySelect.addEventListener("change", loadData);
    personSelect.addEventListener("change", loadData);

    loadData();
  </script>
</body>
</html>
